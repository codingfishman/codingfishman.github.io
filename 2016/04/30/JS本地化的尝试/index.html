<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="codingfishman.github.io"><title>JS本地化的尝试 | codingfishman</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JS本地化的尝试</h1><a id="logo" href="/.">codingfishman</a><p class="description">细雨湿衣看不见，闲花落地听无声</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JS本地化的尝试</h1><div class="post-meta">Apr 30, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/04/30/JS本地化的尝试/" href="/2016/04/30/JS本地化的尝试/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>还记得去年在百姓网组织的一次meetup上，听到过sofish分享了饿了么前端的一些架构，当时印象最深的是proxy_pass解决跨域问题，只听过词汇却不知道是什么意思。后来大量依赖NGINX，proxy_pass已经可以说是用得最多的一个配置了。还记得当时他们提到了请求合并、JS本地化，觉得实为厉害，但一直都没有机会实践。前不久突然想到我们的前端项目，尤其是通过APP加载的H5工程，应该很适合做本地化，于是也实践了一下。</p>
<h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>通过将JS首次访问时缓存在localstorage中，后续的再次访问都从localstorage中读取js文件，也就不用再下载这个JS了（一般也是整个工程中最大的文件）。同时，当我们服务器端的js有改动更新时，我们也需要更新该缓存中的JS文件。</p>
<p>由于每次文件有变动时，文件名都会改变，我想找到一个支持通过token来更新本地JS的库，这样和目前的项目结构最匹配，我发现<a href="https://addyosmani.com/basket.js/" target="_blank" rel="noopener">basket.js</a> 恰好满足这个要求。</p>
<blockquote>
<p>basket.js 不能单独使用，它依赖于<a href="https://github.com/tildeio/rsvp.js" target="_blank" rel="noopener">rsvp.js</a>来异步加载JS，其本身只是localstorage的操作逻辑。</p>
</blockquote>
<h2 id="改造"><a href="#改造" class="headerlink" title="改造"></a>改造</h2><p>我直接在首页文件中加入改JS代码，而没有再创建其他文件来做这件事。 因为只需要在生产环境做本地化缓存，默认将这段代码注释。<br>同时，项目的JS文件是动态生成的，其文件名也会跟随着JS内容变化而变化，故文件名是需要在编译器做静态替换的。</p>
<blockquote>
<p>此处没有注释，为了markdown语法高亮的效果</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* COMMENT_BEGIN_PLACEHOLDER */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadJs</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> mobileScript = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">  mobileScript.setAttribute(<span class="string">'src'</span>, path)</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(mobileScript)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basketload</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  basket.require(</span><br><span class="line">        &#123;<span class="attr">url</span>:<span class="string">'MAIN-JS-PLACEHOLDER'</span>, <span class="attr">key</span>: <span class="string">'main-js'</span>, <span class="attr">unique</span>:<span class="string">'MAIN_JS_UNIQUE_HOLDER'</span>, <span class="attr">expire</span>: <span class="number">168</span>&#125;</span><br><span class="line">      )</span><br><span class="line">      .then(<span class="function"><span class="keyword">function</span> (<span class="params">success</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.error(error)</span><br><span class="line">      &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.localStorage) &#123;</span><br><span class="line">      basketload()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.info(<span class="string">'不支持localStorage'</span>)</span><br><span class="line">      loadJs(<span class="string">'MAIN-JS-PLACEHOLDER'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(<span class="string">'尝试读取local storage 失败'</span>)</span><br><span class="line">  loadJs(<span class="string">'MAIN-JS-PLACEHOLDER'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* COMMENT_END_PLACEHOLDER */</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在此，我使用了 <code>MAIN-JS-PLACEHOLDER</code> 来作为生成JS文件名的placeholder， 使用 <code>MAIN_JS_UNIQUE_HOLDER</code>来当做该JS是否变化的token标示符。也可以直接使用文件名做标识符，不过我其实取出了文件名中的MD5作为标识符。同时，我设置了过期时间为168小时，即一星期。</p>
</blockquote>
<p>通过编译工具，将上面代码中的placeholder替换完成，并将注释符号删除，就可以使其工作了。 在如上代码中，我也针对一些不支持localstorage的场景，比如隐身模式，做了异常处理，针对这些场景我会直接请求原始JS代码。</p>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>有的同学可能发现，我上面的代码有一个前提，那就是已经提前加载了 baseket.js (basket.js+rsvp.js可以手工合并)。既然都已经判断是否支持localstorage，那么为何不在判断结束后再插入basket.js呢，这样在不支持localstorage的地方，就可以节省一个不必要的请求呀？</p>
<p>确实我一开始也这么打算，因为真的很不喜欢请求多余的资源，而且既然这样可以实现何必不呢？<br>因此一开始的版本其实是这样的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.localStorage) &#123;</span><br><span class="line">        loadJs(<span class="string">'/pathofjs/basket.min.js'</span>)</span><br><span class="line">        <span class="comment">// 通过onload事件，在JSbasket.min.js加载结束后，加载我们真正需要的JS文件</span></span><br><span class="line">        <span class="built_in">window</span>.onload = basketload</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">'不支持localStorage'</span>)</span><br><span class="line">        loadJs(<span class="string">'MAIN-JS-PLACEHOLDER'</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">'尝试读取local storage 失败'</span>)</span><br><span class="line">    loadJs(<span class="string">'MAIN-JS-PLACEHOLDER'</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>看起来也没什么问题，但是问题还是来了，来自中国移动！由于该网站还没有切换到HTTPS，中国移动在里面劫入了自己的JS文件，域名赤裸裸地绑定在10086.cn下。我们在测试的时候，发现移动页面很久才能打开。经调试，中国移动的一个js文件（base.js, 才几KB），有时候要经过50多秒才能下载完，<code>window.onload</code>也会等待这个下载完才执行，因此页面内容也不会被初始化。项目正在迁移HTTPS，但毕竟还有个过程，因此忍痛放弃了这种方式，直接加载baseket.js了。</p>
<blockquote>
<p>basket.js 在我禁用缓存进行测试时，会抛一个读取localstorage的异常， 还是毕竟烦人，故而我在里面加入了一段主动判断localstorage的地方，并catch这个异常，虽然没什么用，但是毕竟没有红色警告了。。</p>
</blockquote>
<p>以上，JS本地化的迁移就算是告一段落了。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"root"</span> <span class="attr">style</span>=<span class="string">"height: 100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>sss</p>
</div><a data-url="http://codingfishman.github.io/2016/04/30/JS本地化的尝试/" data-id="cj1at4mvu0015np2qn9pd1wlu" class="article-share-link">分享到</a><div class="tags"><a href="/tags/JavaScript-性能优化/">JavaScript 性能优化</a></div><div class="post-nav"><a href="/2016/05/06/prerender预渲染优化SEO/" class="pre">Prerender预渲染优化SEO</a><a href="/2016/04/30/NINGX-try-files-And-add-header/" class="next">NGINX add_header 在try_files中不生效</a></div><div id="disqus_thread"><script>var disqus_shortname = 'codingfishman';
var disqus_identifier = '2016/04/30/JS本地化的尝试/';
var disqus_title = 'JS本地化的尝试';
var disqus_url = 'http://codingfishman.github.io/2016/04/30/JS本地化的尝试/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//codingfishman.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/angular-javascript/" style="font-size: 15px;">angular javascript</a> <a href="/tags/CSS-CSS3-H5-Mobile/" style="font-size: 15px;">CSS CSS3 H5 Mobile</a> <a href="/tags/Javascript/" style="font-size: 15px;">Javascript</a> <a href="/tags/CSS-BFC/" style="font-size: 15px;">CSS BFC</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/CSS-React/" style="font-size: 15px;">CSS React</a> <a href="/tags/Angular-Prerender-SEO-NGINX/" style="font-size: 15px;">Angular Prerender SEO NGINX</a> <a href="/tags/webpack-css-css-modules/" style="font-size: 15px;">webpack css css-modules</a> <a href="/tags/CSS3-flex-Mobile/" style="font-size: 15px;">CSS3 flex Mobile</a> <a href="/tags/日记/" style="font-size: 15px;">日记</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/NGINX/" style="font-size: 15px;">NGINX</a> <a href="/tags/JavaScript-性能优化/" style="font-size: 15px;">JavaScript 性能优化</a> <a href="/tags/javascript-ES5/" style="font-size: 15px;">javascript ES5</a> <a href="/tags/JavaScript-工具/" style="font-size: 15px;">JavaScript 工具</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/10/image-diff/">视觉比对小工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/11/技术之梦与业务之实/">从“点赞”到“框架”，发现业务本身的价值</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/17/ES6 的yield是如何执行和接受参数的/">ES6的yield是如何执行和接受参数的</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/29/函数声明与函数表达式/">函数声明与函数表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/flex布局当overflow时无法滑动到顶部/">flex布局当overflow时无法滑动到顶部</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/21/我们经常看到的"!!obj"/">我们经常看到的"!!obj"</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/06/prerender预渲染优化SEO/">Prerender预渲染优化SEO</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/30/JS本地化的尝试/">JS本地化的尝试</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/30/NINGX-try-files-And-add-header/">NGINX add_header 在try_files中不生效</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/24/基于最基本的float-overflow实现动态布局/">基于最基本的float+overflow实现calc的CSS效果</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//codingfishman.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">codingfishman.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/share.js?v=0.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>